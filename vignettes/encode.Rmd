---
title: "Advanced Bioconductor: working with ENCODE"
author: "Vincent J. Carey, stvjc at channing.harvard.edu"
date: "`r format(Sys.time(), '%B %d, %Y')`"
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Working with ENCODE}
  %\VignetteEncoding{UTF-8}
output:
  BiocStyle::html_document:
    highlight: pygments
    number_sections: yes
    theme: united
    toc: yes
    toc_depth: 3
---

```{r setup,echo=FALSE,results="hide"}
suppressMessages({
suppressPackageStartupMessages({
library(AnnotationHub)
library(rtracklayer)
library(DT)
library(tibble)
library(BiocStyle)
})
})
```

# Introduction

The Encyclopedia of DNA Elements (ENCODE) is a collection of
experimental results and computing resources devoted to elaboration
of mechanisms of gene regulation.  The project [main page](https://www.encodeproject.org/)
is a good overview of its scope, involving four main organisms (human, mouse, worm
and fly) and dozens of biotechnological innovations that
are used to analyze gene structure and
regulation.  In this section we will illustrate ways of using Bioconductor
to acquire and interpret ENCODE resources.

# Built-in surveys through ENCODExplorer metadata

We can use AnnotationHub to get information on ENCODE results that have
been curated for direct use with Bioconductor.  The
`r Biocpkg("ENCODExplorer")` package provides a metadata table,
that we retrieve using `r Biocpkg("AnnotationHub")`.  We use
the "full" table because it provides links to raw and processed data files
curated in the cloud by the ENCODE project.  

## Population of/loading from local metadata cache 

This table is over 90MB in
size, so it takes a few moments to download or load from cache.

```{r doen1,cache=TRUE}
library(AnnotationHub)
ah = AnnotationHub()
query(ah, "ENCODExplorerData")
fm = ah[["AH75132"]]
dim(fm)
table(fm$organism)
```

## Filtering the metadata table

We focus on human samples, and limit to ChIP-seq
experiments for now.
```{r doen2, cache=TRUE}
# filter
hfm = fm[which(fm$organism == "Homo sapiens"),]
tail(sort(table(hfm$assay)))
hfmt = hfm[which(hfm$assay == "TF ChIP-seq"),]
```

The proteins for which binding patterns can be
assessed are in the `antibody_target` field:
```{r lkst}
tail(sort(table(hfmt$antibody_target)))
```

## Managing the information with a GenomicFiles instance 

We'll manage the ChIP-seq data references with a
`r Biocpkg("GenomicFiles")` object.
For convenience, we'll focus on BED files with
narrowPeak content.

```{r dolim}
hfmtbn = hfmt[hfmt$file_type == "bed narrowPeak",]
dim(hfmtbn)
table(hfmtbn$output_type)
```
Note that IDR denotes "irreproducible discovery rate" a measure of
confidence [developed within ENCODE](https://genome.ucsc.edu/ENCODE/qualityMetrics.html).

```{r dogf}
library(GenomicFiles)
gf1 = GenomicFiles(files=hfmtbn$s3_uri)
colData(gf1) = as(as.data.frame(hfmtbn), "DataFrame")
table(gf1$assembly)
```
This last table is very important, indicating that we are managing information
for which two genomic coordinate systems are in play.  In the introduction
to Bioconductor, it is shown
how `liftOver` can be used to translate between coordinate systems if needed.

We'll focus on data collected with GRCh38 coordinates.
```{r limg}
gf1 = gf1[, which(gf1$assembly == "GRCh38")]
gf1
```

## Anatomic sources of samples

We'll define a helper function to report on discrete properties
of samples.  This gives us clues on the contents of listings of biosample type and
associated ontology labels.
```{r lktls}
tls = function(x) tail(sort(table(x)))
tls(gf1$biosample_name)
tls(gf1$biosample_ontology)
```

The use of ontology labeling helps us to organize information on samples.
Bioconductor's `r Biocpkg("ontoProc")` package can be used to
develop a simple hierarchical display.  We focus on the Experimental Factor
Ontology (EFO) tags, and take a very small subset of tags in use to
obtain a tractable display in this document.
```{r lkontopl}
library(ontoProc)
ee = getEFOOnto()
tail(sort(table(hfmt$biosample_ontology)),12) -> ioi
nn = names(ioi[grep("EFO", names(ioi))])
tails = gsub(".*_", "", nn)
tailss = gsub("/", "", tails)
tt = paste0("EFO:", tailss)
onto_plot2(ee, tt, cex=.6)
```
